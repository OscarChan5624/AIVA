#:import utils kivy.utils
#:import dp kivy.metrics.dp
#:import ButtonBehavior kivy.uix.behaviors.ButtonBehavior

# AI Insights Dashboard Card
<AIInsightsCard@ButtonBehavior+BoxLayout>:
    orientation: "vertical"
    size_hint_y: None
    height: "140dp"
    padding: [16, 16, 16, 16]
    spacing: 12
    background_color: 0, 0, 0, 0
    canvas.before:
        # Card background - pure black (no purple)
        Color:
            rgba: 0, 0, 0, 1
        RoundedRectangle:
            radius: [16,]
            pos: self.pos
            size: self.size
    
    # Header row with AI icon and title - FIXED AT TOP
    BoxLayout:
        size_hint_y: None
        height: "28dp"
        spacing: 10
        padding: 0
        
        # AI Icon (using Image widget)
        Image:
            source: 'sparkle.png'
            size_hint_x: None
            width: "24dp"
            height: "24dp"
            allow_stretch: True
            keep_ratio: True
        
        # Title
        Label:
            text: "AI Insights"
            color: 1, 1, 1, 1
            bold: True
            font_size: "16sp"
            halign: "left"
            valign: "middle"
            text_size: self.size
            size_hint_x: 1
        
        # Refresh button (using IconButton)
        IconButton:
            source: 'refresh.png'
            size_hint: None, None
            size: "24dp", "24dp"
            on_release: app.refresh_ai_insights()
    
    # Main insight content area - takes remaining space
    Label:
        id: primary_insight
        text: app.ai_insight_text
        color: utils.get_color_from_hex('#cfd2ff')
        font_size: "14sp"
        halign: "left"
        valign: "top"
        text_size: self.width - dp(4), None
        size_hint_y: 1
        shorten: False
        markup: False
        on_width: self.text_size = (self.width - dp(4), None) if self.width > 0 else (None, None)

# AI Insights Popup
<AIInsightsPopup@Popup>:
    title: ''
    title_size: 0
    size_hint: 0.96, 0.85
    auto_dismiss: True
    background_color: 0.06, 0.06, 0.14, 0.95
    separator_height: 0
    
    BoxLayout:
        orientation: 'vertical'
        padding: dp(12)
        spacing: dp(12)
        canvas.before:
            Color:
                rgba: utils.get_color_from_hex('#101024')
            Rectangle:
                pos: self.pos
                size: self.size
        
        # Header
        BoxLayout:
            size_hint_y: None
            height: dp(50)
            spacing: dp(12)
            
            Label:
                text: 'AI Insights'
                color: 1, 1, 1, 1
                font_size: '22sp'
                bold: True
                halign: 'left'
                valign: 'middle'
                text_size: self.size
                size_hint_x: 1
            
            Button:
                text: 'X'
                size_hint: None, None
                size: dp(40), dp(40)
                background_normal: ''
                background_color: 0.8, 0.2, 0.2, 1
                color: 1, 1, 1, 1
                font_size: '18sp'
                bold: True
                on_release: root.dismiss()
        
        # Insight Type Buttons (Horizontal Scroll)
        ScrollView:
            size_hint_y: None
            height: dp(50)
            do_scroll_x: True
            do_scroll_y: False
            bar_width: 0
            
            BoxLayout:
                id: insight_types_container
                orientation: 'horizontal'
                size_hint_x: None
                width: self.minimum_width
                spacing: dp(8)
                padding: dp(4)
        
        # Main Insight Display Area
        ScrollView:
            id: insights_scroll
            do_scroll_x: False
            bar_color: 1, 1, 1, 0.3
            bar_inactive_color: 1, 1, 1, 0.1
            
            BoxLayout:
                id: insights_container
                orientation: 'vertical'
                size_hint_y: None
                height: self.minimum_height
                spacing: dp(12)
                padding: dp(4)
        
        # Refresh Button
        Button:
            text: 'Refresh Insight'
            size_hint_y: None
            height: dp(50)
            background_normal: ''
            background_color: 0.65, 0.5, 0.98, 0.8
            color: 1, 1, 1, 1
            font_size: '16sp'
            bold: True
            on_release: app.refresh_all_insights()

